(env
 (dev
  (flags
   (:standard -w +A-40-48-42-44 -warn-error +A-3))))

(subdir
 asset/
 (rule
  (target main.js)
  (deps ../bin/main.bc.js)
  (mode (promote-until-clean))
  (action
   (copy %{deps} %{target}))))

{% if include_tailwind == "true" %}
(subdir
 asset/
 (rule
  (target main.css)
  (deps
   (:data ../tailwind.config.js)
   (source_tree ../node_modules)
   (source_tree ../lib/**/*)
   (env_var NODE_ENV))
  (action
   (chdir
    %{workspace_root}
    ; We use node_modules/tailwindcss/lib/cli.js instead of `npx tailwindcss`
    ; because dune won't include node_modules/.bin in the build, no matter
    ; what I do.
    (run
     node
     node_modules/tailwindcss/lib/cli.js
     build
     -c
     tailwind.config.js
     -o
     %{target})))))
{% endif %}